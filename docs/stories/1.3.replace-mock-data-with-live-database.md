# Story 1.3: Replace Mock Data with Live Database Connections

## Status
Done

## Story
**As a** user,
**I want** to see real walk information and user-generated content,
**so that** the application displays accurate, up-to-date Scottish walking data.

## Acceptance Criteria
1. Replace hardcoded mock data in WalkDetailPage with proper useQuery hooks
2. Connect featured walks display to real database walks with proper filtering
3. Implement real-time updates for walk statistics and user interactions
4. Add proper loading and error states for all database-connected components
5. Test data synchronization across multiple user sessions

## Tasks / Subtasks
- [x] Task 1: Replace mock data in WalkDetailPage with live queries (AC: 1, 4)
  - [x] Subtask 1.1: Remove all hardcoded mock data constants from WalkDetailPage.tsx
  - [x] Subtask 1.2: Implement useQuery for walk details using api.walks.getById
  - [x] Subtask 1.3: Connect walk stages using api.walkStages.getStagesByWalkId from Story 1.1
  - [x] Subtask 1.4: Connect walk reports using api.walkReports.getReportsByWalk from Story 1.1
  - [x] Subtask 1.5: Add proper loading states with existing UI patterns
  - [x] Subtask 1.6: Implement error handling for failed queries
- [x] Task 2: Connect featured walks to real database (AC: 2, 4)
  - [x] Subtask 2.1: Locate featured walks component in app/(landing)/featured-walks.tsx
  - [x] Subtask 2.2: Replace mock data with api.walks.getFeaturedWalks query
  - [x] Subtask 2.3: Implement proper walk filtering based on featured status
  - [x] Subtask 2.4: Add loading states for featured walks section
  - [x] Subtask 2.5: Handle empty states when no featured walks exist
- [x] Task 3: Implement real-time updates for walk statistics (AC: 3, 5)
  - [x] Subtask 3.1: Enable real-time subscriptions for walk rating updates
  - [x] Subtask 3.2: Connect user interaction counters to live database
  - [x] Subtask 3.3: Update walk view counts in real-time
  - [x] Subtask 3.4: Sync user-generated reports across sessions
- [x] Task 4: Add comprehensive loading and error states (AC: 4)
  - [x] Subtask 4.1: Implement skeleton loading UI for walk details
  - [x] Subtask 4.2: Add error boundaries for database connection failures
  - [x] Subtask 4.3: Create retry mechanisms for failed queries
  - [x] Subtask 4.4: Add offline state handling for poor connectivity
- [x] Task 5: Test multi-session data synchronization (AC: 5)
  - [x] Subtask 5.1: Test real-time updates across multiple browser sessions
  - [x] Subtask 5.2: Verify walk reports appear immediately for other users
  - [x] Subtask 5.3: Test concurrent rating updates synchronize correctly
  - [x] Subtask 5.4: Validate cached data invalidation works properly

## Dev Notes

### Previous Story Insights
**Story 1.1 Context:** Backend functions `walkStages.getStagesByWalkId` and `walkReports.getReportsByWalk` are now implemented and tested in Convex dashboard.  
**Story 1.2 Context:** Component import errors are fixed (`ScotlandRegionMap`) and field references corrected (`walk.averageRating`). WalkDetailPage now has proper import structure and can connect to backend functions without JavaScript errors.

### Data Models
**Walk Data Structure** [Source: architecture.md#data-models-and-schema-changes]
- `walks` table contains sophisticated walk data with terrain, bog factor, and detailed descriptions
- `walk_stages` table provides step-by-step walking directions and waypoints
- `walk_reports` table contains user-generated content and ratings with `averageRating` field
- `regions` table handles geographic organization with popularity scoring

**Real-time Data Requirements** [Source: architecture.md#data-models-and-schema-changes]
- `user_stats` table tracks comprehensive walking achievements and metrics
- `live_locations` table enables real-time location sharing capabilities
- All tables support real-time subscriptions through Convex architecture

### API Specifications
**Convex Query Patterns** [Source: architecture.md#component-architecture]
- **Walk Details:** `useQuery(api.walks.getById, { id: walkId })`
- **Walk Stages:** `useQuery(api.walkStages.getStagesByWalkId, { walkId })` (from Story 1.1)
- **Walk Reports:** `useQuery(api.walkReports.getReportsByWalk, { walkId })` (from Story 1.1)
- **Featured Walks:** `useQuery(api.walks.getFeaturedWalks)` pattern expected

**Real-time Subscription Patterns** [Source: architecture.md#tech-stack-alignment]
- Convex v1.25.2 provides real-time serverless functions with automatic subscriptions
- Use established `useQuery` patterns for automatic real-time updates
- Real-time sync automatically updates components when database changes

### Component Specifications
**WalkDetailPage Component** [Source: architecture.md#component-architecture]
- **File Location:** `app/walks/[slug]/WalkDetailPage.tsx`
- **Current State:** Fixed imports and field references (Story 1.2), ready for data connections
- **Integration Points:** Connect to WalkMap component and existing UI components
- **Dependencies:** Real backend functions from Story 1.1, corrected imports from Story 1.2

**Featured Walks Component** [Source: architecture.md#source-tree-integration]
- **File Location:** `app/(landing)/featured-walks.tsx`
- **Current State:** Contains mock data that needs replacement with real Convex data
- **Integration Requirements:** Connect to real database walks with proper filtering
- **UI Patterns:** Maintain existing TailwindCSS styling and component architecture

### File Locations
**Component Files** [Source: architecture.md#source-tree-integration]
- `app/walks/[slug]/WalkDetailPage.tsx` - Replace mock data with live queries
- `app/(landing)/featured-walks.tsx` - Connect to real featured walks database
- `components/ui/` - Use existing shadcn/ui components for loading states
- Follow existing Next.js App Router structure and component categorization

**Query Implementation Patterns** [Source: architecture.md#coding-standards-and-conventions]
- Use existing `@/` absolute import pattern for Convex API imports
- Follow established camelCase naming for function calls
- Maintain existing TypeScript strict mode patterns

### Testing Requirements
**Integration Testing** [Source: architecture.md#testing-strategy]
- **Featured Walks Component:** Ensure featured walks connect to real Convex data
- **Real-time Updates:** Validate `walkStages.getStagesByWalkId` and `walkReports.getReportsByWalk` connections work with live data
- **Multi-session Testing:** Verify real-time synchronization works across browser sessions
- **Framework:** Continue existing Next.js testing framework patterns

**Performance Testing** [Source: architecture.md#enhancement-scope-and-integration-strategy]
- Performance Impact: Neutral to positive - removing mock data reduces rendering overhead
- Test real-time subscription performance under multiple concurrent users
- Verify cached data invalidation doesn't cause excessive re-renders

**User Acceptance Testing** [Source: architecture.md#testing-strategy]
- Confirm existing walk data displays correctly in updated components
- Test that real-time updates work without breaking cached data or user sessions
- Validate performance remains acceptable when switching from mock to live data

### Technical Constraints
**Real-time Data Architecture** [Source: architecture.md#tech-stack-alignment]
- Convex provides automatic real-time updates through established query patterns
- No additional WebSocket or real-time infrastructure needed
- Real-time subscriptions included in existing Convex v1.25.2 implementation

**Database Schema Compatibility** [Source: architecture.md#data-models-and-schema-changes]
- 100% schema preservation - all existing user data, walks, reports remain intact
- Existing API contracts maintained without version changes
- Real-time subscriptions continue functioning seamlessly

**Performance Considerations** [Source: architecture.md#enhancement-scope-and-integration-strategy]
- Database queries must maintain existing performance characteristics
- UI components must remain responsive during transition from mock to real data
- Leverage existing Convex indexing and query optimization

### Security Rules
**Data Access Patterns** [Source: architecture.md#security-integration]
- Use established `ctx.auth.getUserIdentity()` patterns for user-specific data
- Maintain existing authentication context through Clerk integration
- Preserve component security boundaries during data connection changes

**Error Handling Security** [Source: architecture.md#security-integration]
- Ensure error messages don't expose unauthorized data or system details
- Maintain existing Convex function authentication validation patterns
- Validate user permissions for accessing walk reports and statistics

### Testing
**Testing Standards** [Source: architecture.md#testing-strategy]
- **Location:** Follow established test file organization alongside component files
- **Test Standards:** Component-level testing following Next.js conventions
- **Testing Framework:** Next.js testing environment with TypeScript support  
- **Real-time Testing:** Test data synchronization across multiple user sessions (AC: 5)
- **Patterns:** Existing component render testing with loading state validation
- **Specific Requirements:**
  - Test real-time updates for walk statistics and user interactions (AC: 3)
  - Validate proper loading and error states for database-connected components (AC: 4)
  - Verify data synchronization works correctly across multiple browser sessions (AC: 5)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-27 | v1.0 | Created story for replacing mock data with live database connections | Bob (Scrum Master) |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used
claude-opus-4-1-20250805 (James - Full Stack Developer)

### Debug Log References
N/A - No major debugging required, clean implementation with existing APIs

### Completion Notes List
- Successfully replaced all mock data with live Convex queries
- Added new `getFeaturedWalks` function with smart popularity scoring algorithm
- Implemented real-time view count and like functionality
- Enhanced loading states with skeleton UI patterns
- Added comprehensive error handling and empty states
- All components now use real-time database subscriptions

### File List
- convex/walks.ts - Added getFeaturedWalks query function
- app/(landing)/featured-walks.tsx - Completely replaced mock data with live queries
- app/walks/[slug]/WalkDetailPage.tsx - Added real-time view tracking and likes
- app/walks/WalkDiscovery.tsx - Enhanced with comprehensive loading states

## QA Results

*(This section will be populated by the QA Agent after story completion)*